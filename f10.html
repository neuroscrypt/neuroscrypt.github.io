<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–π –∏ –ø–æ–∑</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #0a0a0a;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      color: #e0e0e0;
    }

    #video {
      position: absolute;
      opacity: 0;
      transform: scaleX(-1);
    }

    #overlay {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 127, 0.3);
      background: #1a1a1a;
      transition: all 0.3s ease;
    }

    .panel {
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 127, 0.2);
      padding: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 127, 0.2);
    }

    #topPanel {
      position: fixed;
      top: 0;
      left: 0;
      right: 350px;
      height: 100px;
      z-index: 3;
      text-align: center;
    }

    #leftPanel {
      position: fixed;
      top: 100px;
      left: 0;
      width: 200px;
      bottom: 100px;
      text-align: center;
    }

    #bottomPanel {
      position: fixed;
      left: 0;
      right: 350px;
      bottom: 0;
      height: 100px;
      z-index: 3;
    }

    #panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 350px;
      height: 100%;
      overflow-y: auto;
      z-index: 3;
    }

    .fluorescent {
      animation: fluorescentGlow 2s infinite;
      text-shadow: 0 0 10px #B4FF9F;
    }

    @keyframes fluorescentGlow {
      0%, 100% { filter: drop-shadow(0 0 10px #B4FF9F); }
      50% { filter: drop-shadow(0 0 20px #FFEE93); }
    }

    .slider input[type="range"] {
      width: 100%;
      height: 5px;
      background: #2a2a2a;
      outline: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .slider input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 15px;
      height: 15px;
      background: #00ff7f;
      border-radius: 50%;
      cursor: pointer;
    }

    button {
      background: #00ff7f;
      color: #002710;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #B4FF9F;
      box-shadow: 0 0 15px #00ff7f;
    }

    .info span {
      display: block;
      margin: 5px 0;
      padding: 3px;
      background: rgba(0, 255, 127, 0.1);
      border-radius: 3px;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
</head>
<body>
  <video id="video" width="1280" height="960" autoplay muted></video>
  <canvas id="overlay" width="1280" height="960"></canvas>

  <div id="topPanel" class="panel fluorescent">
    <h2>¬´–ö–æ–º–ø–∞—Å –ë–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–≥–æ¬ª</h2>
    <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è</p>
  </div>

  <div id="leftPanel" class="panel fluorescent">
    <h2>–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <p>–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞...</p>
  </div>

  <div id="bottomPanel" class="panel fluorescent">
    <h2>¬´–ù–ï–ô–†–û–°–ö–†–ò–ü–¢¬ª</h2>
    <p>2025 ¬© –ö–≤–∞–Ω—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è</p>
  </div>

  <div id="panel" class="panel">
    <h2 class="fluorescent">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h2>
    
    <div id="faceSection">
      <h3 class="fluorescent">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
      <div class="info"><span id="faceCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Ü: 0</span></div>
      <ul id="faceDetails"></ul>
    </div>

    <div id="poseSection">
      <h3 class="fluorescent">–ö–∏–Ω–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</h3>
      <ul id="poseDetails"></ul>
    </div>

    <div class="slider">
      <label>–ú–∞—Å—à—Ç–∞–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
      <input type="range" id="canvasWidth" min="640" max="1920" value="1280">
      <span id="widthValue">1280 px</span>
    </div>

    <div class="toggle-btn">
      <button id="toggleRender">–†–µ–∂–∏–º: –†–∞–º–∫–∞</button>
    </div>
  </div>

  <script>
    const EMOTION_STABILITY_FRAMES = 5;
    const PANEL_UPDATE_INTERVAL = 500;
    const MIN_KEYPOINT_SCORE = 0.5;

    const emotionMapping = {
      angry: "ü§¨ –ê–≥—Ä–µ—Å—Å–∏—è",
      disgusted: "ü§¢ –û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ",
      fearful: "üò® –°—Ç—Ä–∞—Ö",
      happy: "üòÉ –†–∞–¥–æ—Å—Ç—å",
      neutral: "üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ",
      sad: "üò¢ –ì—Ä—É—Å—Ç—å",
      surprised: "üòØ –£–¥–∏–≤–ª–µ–Ω–∏–µ"
    };

    const poseMapping = {
      nose: "üëÉ –ù–æ—Å",
      leftEye: "üëÅ –õ–µ–≤—ã–π –≥–ª–∞–∑",
      rightEye: "üëÅ –ü—Ä–∞–≤—ã–π –≥–ª–∞–∑",
      leftEar: "üëÇ –õ–µ–≤–æ–µ —É—Ö–æ",
      rightEar: "üëÇ –ü—Ä–∞–≤–æ–µ —É—Ö–æ",
      leftShoulder: "üí™ –õ–µ–≤–æ–µ –ø–ª–µ—á–æ",
      rightShoulder: "üí™ –ü—Ä–∞–≤–æ–µ –ø–ª–µ—á–æ",
      leftElbow: "ü¶æ –õ–µ–≤—ã–π –ª–æ–∫–æ—Ç—å",
      rightElbow: "ü¶æ –ü—Ä–∞–≤—ã–π –ª–æ–∫–æ—Ç—å",
      leftWrist: "‚úã –õ–µ–≤–∞—è –∫–∏—Å—Ç—å",
      rightWrist: "‚úã –ü—Ä–∞–≤–∞—è –∫–∏—Å—Ç—å",
      leftHip: "ü¶µ –õ–µ–≤—ã–π —Ç–∞–∑",
      rightHip: "ü¶µ –ü—Ä–∞–≤—ã–π —Ç–∞–∑",
      leftKnee: "ü¶µ –õ–µ–≤–æ–µ –∫–æ–ª–µ–Ω–æ",
      rightKnee: "ü¶µ –ü—Ä–∞–≤–æ–µ –∫–æ–ª–µ–Ω–æ",
      leftAnkle: "ü¶∂ –õ–µ–≤–∞—è –ª–æ–¥—ã–∂–∫–∞",
      rightAnkle: "ü¶∂ –ü—Ä–∞–≤–∞—è –ª–æ–¥—ã–∂–∫–∞"
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    let posenetModel;
    let faceRenderMode = "—Ä–∞–º–∫–∞";
    let stableEmotion = null;

    document.getElementById('toggleRender').onclick = () => {
      faceRenderMode = faceRenderMode === "—Ä–∞–º–∫–∞" ? "–º–∞—Å–∫–∞" : "—Ä–∞–º–∫–∞";
      document.getElementById('toggleRender').textContent = `–†–µ–∂–∏–º: ${faceRenderMode}`;
    };

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        return new Promise(resolve => video.onloadedmetadata = () => resolve(video));
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
        throw error;
      }
    }

    function scaleCoordinates(x, y) {
      const scaleX = canvas.width / video.videoWidth;
      const scaleY = canvas.height / video.videoHeight;
      return { x: x * scaleX, y: y * scaleY };
    }

    async function processFrame() {
      const [faces, pose] = await Promise.all([
        faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks()
          .withFaceExpressions(),
        posenetModel.estimateSinglePose(video)
      ]);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#00ff7f';
      ctx.fillStyle = '#00ff7f';
      ctx.lineWidth = 2;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—Ü
      faces.forEach(face => {
        const box = face.detection.box;
        const scaledBox = scaleCoordinates(box.x, box.y);
        const scaledWidth = box.width * (canvas.width / video.videoWidth);
        const scaledHeight = box.height * (canvas.height / video.videoHeight);

        if (faceRenderMode === "—Ä–∞–º–∫–∞") {
          ctx.strokeRect(scaledBox.x, scaledBox.y, scaledWidth, scaledHeight);
        } else {
          faceapi.draw.drawFaceLandmarks(canvas, face);
        }

        const emotion = Object.entries(face.expressions)
          .reduce((a, b) => a[1] > b[1] ? a : b)[0];
        ctx.font = '16px Segoe UI';
        ctx.fillText(emotionMapping[emotion], scaledBox.x, scaledBox.y - 10);
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∑—ã
      pose.keypoints.forEach(kp => {
        if (kp.score > MIN_KEYPOINT_SCORE) {
          const pos = scaleCoordinates(kp.position.x, kp.position.y);
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
          ctx.fill();
        }
      });

      requestAnimationFrame(processFrame);
    }

    async function init() {
      try {
        await setupCamera();
        video.play();
        
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(
            'https://justadudewhohacks.github.io/face-api.js/models'
          ),
          posenet.load()
        ]);

        processFrame();
      } catch (error) {
        showError('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + error.message);
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px;
        background: #ff0066;
        color: white;
        border-radius: 5px;
        z-index: 999;
        animation: fluorescentGlow 1s infinite;
      `;
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);
    }

    init();
  </script>
</body>
</html>
