<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–º–æ—Ü–∏–π –∏ –ø–æ–∑</title>
  <style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
      margin: 0;
      background: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ ‚Äì —Å–∫—Ä—ã—Ç–æ */
    #video {
      position: absolute;
      opacity: 0;
    }
    /* Canvas —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    #overlay {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      background: #fff;
    }
    /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) ‚Äì —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è 350px x 100% */
    #panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 350px;
      height: 100%;
      background-color: #fff;
      padding: 16px;
      z-index: 3;
      overflow-y: auto;
    }
    /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
    #topPanel {
      position: fixed;
      top: 0;
      left: 0;
      right: 350px; /* –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
      height: 100px;
      background-color: #fff;
      padding: 8px;
      z-index: 3;
      text-align: center;
    }
    /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    #leftPanel {
      position: fixed;
      top: 100px;
      left: 0;
      width: 200px;
      bottom: 100px; /* –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
      background-color: #fff;
      text-align: center;
      padding: 15px 25px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      z-index: 3;
    }
    /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    #bottomPanel {
      position: fixed;
      left: 0;
      right: 350px; /* –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
      bottom: 0;
      height: 100px;
      background-color: #fff;
      padding: 8px;
      z-index: 3;
      text-align: center;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø–∞–Ω–µ–ª—è—Ö */
    .info span {
      display: block;
      margin: 3px 0;
      font-size: 14px;
      color: #333;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ */
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 6px;
    }
    /* –ü–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ Canvas */
    .slider {
      margin: 10px 0;
    }
    .slider label {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }
    .slider input[type=range] {
      width: 100%;
    }
    /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü–∞ */
    .toggle-btn {
      margin: 10px 0;
      text-align: center;
    }
    .toggle-btn button {
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      border: 0;
      border-radius: 4px;
      background-color: #f0f0f0;
    }
    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø–∞–Ω–µ–ª–µ–π */
    h2, h3 {
      margin: 8px 0 4px;
      color: #444;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è —Ñ–ª—É–æ—Ä–µ—Å—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Å–≤–µ—á–µ–Ω–∏—è */
    @keyframes fluorescentGlow {
      0%, 100% {
        filter: drop-shadow(0 0 10px #B4FF9F);
      }
      50% {
        filter: drop-shadow(0 0 20px #FFEE93);
      }
    }
    .fluorescent {
      animation: fluorescentGlow 2s infinite;
    }
  </style>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
</head>
<body>
  <!-- –í–∏–¥–µ–æ —Å –≤–µ–±-–∫–∞–º–µ—Ä—ã (—Å–∫—Ä—ã—Ç–æ) -->
  <video id="video" width="1280" height="960" autoplay muted></video>
  <!-- Canvas; –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–∑–º–µ—Ä 1280 x 960 -->
  <canvas id="overlay" width="1280" height="960"></canvas>

  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div id="topPanel">
    <h2 class="fluorescent">¬´–ö–æ–º–ø–∞—Å –ë–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–≥–æ¬ª</h2>
    <p class="fluorescent">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è.</p>
  </div>

  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <div id="leftPanel">
    <h2 class="fluorescent">–õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å</h2>
    <p class="fluorescent">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–ª–∏ –≤–∏–¥–∂–µ—Ç—ã.</p>
  </div>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div id="bottomPanel">
    <h2 class="fluorescent">¬´–ù–ï–ô–†–û–°–ö–†–ò–ü–¢¬ª</h2>
    <p class="fluorescent">2025 ¬©</p>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) -->
  <div id="panel">
    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –ª–∏—Ü -->
    <div id="faceSection">
      <h3>–õ–∏—Ü–∞</h3>
      <div class="info">
        <span id="faceCount" class="faceCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Ü: 0</span>
      </div>
      <ul id="faceDetails">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –ª–∏—Ü—É. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–∞—Ä–∞ <span>: -->
        <!-- –ü–µ—Ä–≤—ã–π <span> –∏–º–µ–µ—Ç –∫–ª–∞—Å—Å, —Ä–∞–≤–Ω—ã–π –∏–º–µ–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "x", "y", –ª–∏–±–æ –∫–ª—é—á –∏–∑ emotionMapping), -->
        <!-- –≤—Ç–æ—Ä–æ–π <span> –∏–º–µ–µ—Ç –∫–ª–∞—Å—Å "dynamicValue"+–∏–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞. -->
      </ul>
    </div>
    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∑—ã -->
    <div id="poseSection">
      <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∑—ã</h3>
      <ul id="poseDetails">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–π –∫–ª—é—á–µ–≤–æ–π —Ç–æ—á–∫–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º -->
      </ul>
    </div>
    <!-- –ü–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞–º–∏ Canvas -->
    <div class="slider">
      <label for="canvasWidth">–®–∏—Ä–∏–Ω–∞</label>
      <input type="range" id="canvasWidth" min="640" max="1920" value="1280">
      <span id="widthValue">1280</span> px
    </div>
    <div class="slider">
      <label for="canvasHeight">–í—ã—Å–æ—Ç–∞</label>
      <input type="range" id="canvasHeight" min="480" max="1440" value="960">
      <span id="heightValue">960</span> px
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü–∞ (—Ä–∞–º–∫–∞ / –º–∞—Å–∫–∞) -->
    <div class="toggle-btn">
      <button id="toggleRender">–†–µ–∂–∏–º: –†–∞–º–∫–∞</button>
    </div>
  </div>
  
  <script>
    // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —ç–º–æ—Ü–∏–π (–∞–Ω–≥–ª. -> —Ä—É—Å.)
    const emotionMapping = {
      angry: "ü§¨ –ê–≥—Ä–µ—Å—Å–∏—è",
      disgusted: "ü§¢ –û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ",
      fearful: "üò® –°—Ç—Ä–∞—Ö",
      happy: "üòÉ –†–∞–¥–æ—Å—Ç—å",
      neutral: "üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ",
      sad: "üò¢ –ì—Ä—É—Å—Ç—å",
      surprised: "üòØ –£–¥–∏–≤–ª–µ–Ω–∏–µ"
    };
    // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –ø–æ–∑—ã (–∞–Ω–≥–ª. -> —Ä—É—Å.)
    const poseMapping = {
      nose: "üëÉ –ù–æ—Å",
      leftEye: "üëÅ –õ–µ–≤—ã–π –≥–ª–∞–∑",
      rightEye: "üëÅ –ü—Ä–∞–≤—ã–π –≥–ª–∞–∑",
      leftEar: "üëÇ –õ–µ–≤–æ–µ —É—Ö–æ",
      rightEar: "üëÇ –ü—Ä–∞–≤–æ–µ —É—Ö–æ",
      leftShoulder: "üí™ –õ–µ–≤–æ–µ –ø–ª–µ—á–æ",
      rightShoulder: "üí™ –ü—Ä–∞–≤–æ–µ –ø–ª–µ—á–æ",
      leftElbow: "ü¶æ –õ–µ–≤—ã–π –ª–æ–∫–æ—Ç—å",
      rightElbow: "ü¶æ –ü—Ä–∞–≤—ã–π –ª–æ–∫–æ—Ç—å",
      leftWrist: "‚úã –õ–µ–≤–∞—è –∫–∏—Å—Ç—å",
      rightWrist: "‚úã –ü—Ä–∞–≤–∞—è –∫–∏—Å—Ç—å",
      leftHip: "ü¶µ –õ–µ–≤—ã–π —Ç–∞–∑",
      rightHip: "ü¶µ –ü—Ä–∞–≤—ã–π —Ç–∞–∑",
      leftKnee: "ü¶µ –õ–µ–≤–æ–µ –∫–æ–ª–µ–Ω–æ",
      rightKnee: "ü¶µ –ü—Ä–∞–≤–æ–µ –∫–æ–ª–µ–Ω–æ",
      leftAnkle: "ü¶∂ –õ–µ–≤–∞—è –ª–æ–¥—ã–∂–∫–∞",
      rightAnkle: "ü¶∂ –ü—Ä–∞–≤–∞—è –ª–æ–¥—ã–∂–∫–∞"
    };

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const faceCountElem = document.getElementById('faceCount');
    const faceDetailsEl = document.getElementById('faceDetails');
    const poseDetailsEl = document.getElementById('poseDetails');
    const widthSlider = document.getElementById('canvasWidth');
    const heightSlider = document.getElementById('canvasHeight');
    const widthValue = document.getElementById('widthValue');
    const heightValue = document.getElementById('heightValue');
    const toggleRenderBtn = document.getElementById('toggleRender');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —ç–º–æ—Ü–∏–π
    let stableEmotion = null;
    let currentEmotion = null;
    let stabilityCount = 0;
    let lastPanelUpdate = Date.now();
    let posenetModel;
    let faceRenderMode = "—Ä–∞–º–∫–∞";  // –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ–∂–∏–º—ã: "—Ä–∞–º–∫–∞" –∏–ª–∏ "–º–∞—Å–∫–∞"

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü–∞
    toggleRenderBtn.onclick = () => {
      faceRenderMode = faceRenderMode === "—Ä–∞–º–∫–∞" ? "–º–∞—Å–∫–∞" : "—Ä–∞–º–∫–∞";
      toggleRenderBtn.textContent = faceRenderMode === "—Ä–∞–º–∫–∞" ? "–†–µ–∂–∏–º: –†–∞–º–∫–∞" : "–†–µ–∂–∏–º: –ú–∞—Å–∫–∞";
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ Canvas
    widthSlider.addEventListener('input', (e) => {
      const newWidth = parseInt(e.target.value);
      widthValue.textContent = newWidth + " px";
      canvas.width = newWidth;
      canvas.style.width = newWidth + "px";
    });
    heightSlider.addEventListener('input', (e) => {
      const newHeight = parseInt(e.target.value);
      heightValue.textContent = newHeight + " px";
      canvas.height = newHeight;
      canvas.style.height = newHeight + "px";
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–∫–∞–º–µ—Ä—ã
    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve(video);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —ç–º–æ—Ü–∏–∏ (–Ω–∞ –æ—Å–Ω–æ–≤–µ 5 –∫–∞–¥—Ä–æ–≤)
    function updateEmotion(newEmotion) {
      if (currentEmotion === newEmotion) {
        stabilityCount++;
        if (stabilityCount >= 5) {
          stableEmotion = newEmotion;
        }
      } else {
        currentEmotion = newEmotion;
        stabilityCount = 1;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è fallback-–¥–∞–Ω–Ω—ã—Ö –ø–æ–∑—ã (–µ—Å–ª–∏ PoseNet –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –ø–æ–∑—É)
    function getFallbackPose() {
      return {
        keypoints: [
          { part: "–Ω–æ—Å", score: 1, position: { x: canvas.width / 2, y: canvas.height / 4 } },
          { part: "–ª–µ–≤—ã–π –≥–ª–∞–∑", score: 1, position: { x: canvas.width / 2 - 20, y: canvas.height / 4 - 10 } },
          { part: "–ø—Ä–∞–≤—ã–π –≥–ª–∞–∑", score: 1, position: { x: canvas.width / 2 + 20, y: canvas.height / 4 - 10 } },
          { part: "–ª–µ–≤–æ–µ —É—Ö–æ", score: 0.8, position: { x: canvas.width / 2 - 40, y: canvas.height / 4 } },
          { part: "–ø—Ä–∞–≤–æ–µ —É—Ö–æ", score: 0.8, position: { x: canvas.width / 2 + 40, y: canvas.height / 4 } },
          { part: "–ª–µ–≤–æ–µ –ø–ª–µ—á–æ", score: 1, position: { x: canvas.width / 2 - 30, y: canvas.height / 2 } },
          { part: "–ø—Ä–∞–≤–æ–µ –ø–ª–µ—á–æ", score: 1, position: { x: canvas.width / 2 + 30, y: canvas.height / 2 } },
          { part: "–ª–µ–≤—ã–π –ª–æ–∫–æ—Ç—å", score: 0.9, position: { x: canvas.width / 2 - 50, y: canvas.height / 2 + 40 } },
          { part: "–ø—Ä–∞–≤—ã–π –ª–æ–∫–æ—Ç—å", score: 0.9, position: { x: canvas.width / 2 + 50, y: canvas.height / 2 + 40 } },
          { part: "–ª–µ–≤–∞—è –∫–∏—Å—Ç—å", score: 0.8, position: { x: canvas.width / 2 - 60, y: canvas.height / 2 + 80 } },
          { part: "–ø—Ä–∞–≤–∞—è –∫–∏—Å—Ç—å", score: 0.8, position: { x: canvas.width / 2 + 60, y: canvas.height / 2 + 80 } },
          { part: "–ª–µ–≤—ã–π —Ç–∞–∑", score: 1, position: { x: canvas.width / 2 - 20, y: canvas.height * 0.75 } },
          { part: "–ø—Ä–∞–≤—ã–π —Ç–∞–∑", score: 1, position: { x: canvas.width / 2 + 20, y: canvas.height * 0.75 } },
          { part: "–ª–µ–≤–æ–µ –∫–æ–ª–µ–Ω–æ", score: 0.9, position: { x: canvas.width / 2 - 20, y: canvas.height - 50 } },
          { part: "–ø—Ä–∞–≤–æ–µ –∫–æ–ª–µ–Ω–æ", score: 0.9, position: { x: canvas.width / 2 + 20, y: canvas.height - 50 } },
          { part: "–ª–µ–≤–∞—è –ª–æ–¥—ã–∂–∫–∞", score: 0.8, position: { x: canvas.width / 2 - 20, y: canvas.height - 10 } },
          { part: "–ø—Ä–∞–≤–∞—è –ª–æ–¥—ã–∂–∫–∞", score: 0.8, position: { x: canvas.width / 2 + 20, y: canvas.height - 10 } }
        ]
      };
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø–∞–Ω–µ–ª–∏:
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Ü–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç <li>, –≤ –∫–æ—Ç–æ—Ä–æ–º:
    //  - –î–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞–º–∫–∏ (x, y, w, h) —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–∞—Ä—ã: –ø–µ—Ä–≤—ã–π <span> —Å –∫–ª–∞—Å—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "x") –∏ —Ç–µ–∫—Å—Ç–æ–º "x: ", –≤—Ç–æ—Ä–æ–π <span> —Å –∫–ª–∞—Å—Å–æ–º "dynamicValuex" –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º.
    //  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è —ç–º–æ—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–∞—Ä—ã <span>: –ø–µ—Ä–≤—ã–π —Å –∫–ª–∞—Å—Å–æ–º —Ä–∞–≤–Ω—ã–º –∫–ª—é—á—É –∏–∑ emotionMapping, –≤—Ç–æ—Ä–æ–π —Å –∫–ª–∞—Å—Å–æ–º "dynamicValue" + –∫–ª—é—á, –≤—ã–≤–æ–¥—è—â–∏–µ –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ.
    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –ø–æ–∑—ã, –¥–ª—è –∫–∞–∂–¥–æ–π –∫–ª—é—á–µ–≤–æ–π —Ç–æ—á–∫–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ—Ä–µ—Ç—Å—è –∏–∑ poseMapping) —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–∞—Ä–∞ <span>.
    function updateInfoPanel(faces, pose) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –ª–∏—Ü–∞–º
      faceDetailsEl.innerHTML = "";
      if (faces && faces.length > 0) {
        faceCountElem.textContent = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Ü: " + faces.length;
        faces.forEach((result, index) => {
          const li = document.createElement("li");
          // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ª–∏—Ü–∞
          const spanHeader = document.createElement("span");
          spanHeader.className = "faceHeader";
          spanHeader.textContent = `–õ–∏—Ü–æ ${index + 1}: `;
          li.appendChild(spanHeader);
          
          const box = result.detection.box;
          // –í—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ x
          const spanXKey = document.createElement("span");
          spanXKey.className = "x";
          spanXKey.textContent = "x: ";
          li.appendChild(spanXKey);
          const spanXVal = document.createElement("span");
          spanXVal.className = "dynamicValuex";
          spanXVal.textContent = Math.round(box.x);
          li.appendChild(spanXVal);
          // –í—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ y
          const spanYKey = document.createElement("span");
          spanYKey.className = "y";
          spanYKey.textContent = ", y: ";
          li.appendChild(spanYKey);
          const spanYVal = document.createElement("span");
          spanYVal.className = "dynamicValuey";
          spanYVal.textContent = Math.round(box.y);
          li.appendChild(spanYVal);
          // –í—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ w
          const spanWKey = document.createElement("span");
          spanWKey.className = "w";
          spanWKey.textContent = ", w: ";
          li.appendChild(spanWKey);
          const spanWVal = document.createElement("span");
          spanWVal.className = "dynamicValuew";
          spanWVal.textContent = Math.round(box.width);
          li.appendChild(spanWVal);
          // –í—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ h
          const spanHKey = document.createElement("span");
          spanHKey.className = "h";
          spanHKey.textContent = ", h: ";
          li.appendChild(spanHKey);
          const spanHVal = document.createElement("span");
          spanHVal.className = "dynamicValueh";
          spanHVal.textContent = Math.round(box.height);
          li.appendChild(spanHVal);
          
          // –í—ã–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π —ç–º–æ—Ü–∏–π
          const expressions = result.expressions;
          Object.keys(expressions).forEach(key => {
            const spanExpKey = document.createElement("span");
            spanExpKey.className = key; // –ò–º—è –∏–∑ emotionMapping (–Ω–∞–ø—Ä–∏–º–µ—Ä, "happy")
            spanExpKey.textContent = `, ${emotionMapping[key] || key}: `;
            li.appendChild(spanExpKey);
            const spanExpVal = document.createElement("span");
            spanExpVal.className = "dynamicValue" + key;
            spanExpVal.textContent = (expressions[key] * 100).toFixed(1) + "%";
            li.appendChild(spanExpVal);
          });
          faceDetailsEl.appendChild(li);
        });
      } else {
        faceCountElem.textContent = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Ü: 0";
        const li = document.createElement("li");
        const spanNone = document.createElement("span");
        spanNone.className = "noFace";
        spanNone.textContent = "–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ";
        li.appendChild(spanNone);
        faceDetailsEl.appendChild(li);
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –ø–æ–∑–µ
      poseDetailsEl.innerHTML = "";
      if (pose && pose.keypoints && pose.keypoints.length > 0) {
        pose.keypoints.forEach(keypoint => {
          const li = document.createElement("li");
          const spanKPKey = document.createElement("span");
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º poseMapping –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–ª—é—á–µ–≤–æ–π —Ç–æ—á–∫–∏
          const partRus = poseMapping[keypoint.part] || keypoint.part;
          spanKPKey.className = keypoint.part; // –ö–ª–∞—Å—Å –ø–æ –∫–ª—é—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "nose")
          spanKPKey.textContent = `${partRus}: `;
          li.appendChild(spanKPKey);
          const spanKPVal = document.createElement("span");
          spanKPVal.className = "dynamicValue" + keypoint.part;
          spanKPVal.textContent = `(x: ${Math.round(keypoint.position.x)}, y: ${Math.round(keypoint.position.y)}; score: ${(keypoint.score * 100).toFixed(1)}%)`;
          li.appendChild(spanKPVal);
          poseDetailsEl.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        const spanNoPose = document.createElement("span");
        spanNoPose.className = "noPose";
        spanNoPose.textContent = "–ü–æ–∑–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞";
        li.appendChild(spanNoPose);
        poseDetailsEl.appendChild(li);
      }
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ
    async function onPlay() {
      if (video.paused || video.ended) {
        requestAnimationFrame(onPlay);
        return;
      }
      const faceOptions = new faceapi.TinyFaceDetectorOptions();
      let faces = await faceapi.detectAllFaces(video, faceOptions)
        .withFaceLandmarks()
        .withFaceExpressions();
      
      let pose = await posenetModel.estimateSinglePose(video, { flipHorizontal: false });
      if (!pose || !pose.keypoints) {
        pose = getFallbackPose();
      }
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏—Ü
      if (faces && faces.length > 0) {
        faces.forEach(result => {
          if (faceRenderMode === "—Ä–∞–º–∫–∞") {
            const { x, y, width, height } = result.detection.box;
            ctx.strokeStyle = 'green';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            const expressions = result.expressions;
            const maxVal = Math.max(...Object.values(expressions));
            const emotionKey = Object.keys(expressions).find(k => expressions[k] === maxVal);
            updateEmotion(emotionKey);
            ctx.fillStyle = 'green';
            ctx.font = '18px Segoe UI';
            ctx.fillText(emotionMapping[stableEmotion] || '', x, y - 10);
          } else {
            if (result.landmarks) {
              faceapi.draw.drawFaceLandmarks(canvas, result);
            }
          }
        });
      } else {
        stableEmotion = null;
        currentEmotion = null;
        stabilityCount = 0;
      }
      
      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –ø–æ–∑—ã
      if (pose && pose.keypoints && pose.keypoints.length > 0) {
        pose.keypoints.forEach(kp => {
          if (kp.score > 0.5) {
            ctx.beginPath();
            ctx.arc(kp.position.x, kp.position.y, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#4285f4';
            ctx.fill();
          }
        });
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø–∞–Ω–µ–ª–∏ (–Ω–µ —á–∞—â–µ, —á–µ–º —Ä–∞–∑ –≤ 500 –º—Å)
      if (Date.now() - lastPanelUpdate > 500) {
        updateInfoPanel(faces, pose);
        lastPanelUpdate = Date.now();
      }
      
      requestAnimationFrame(onPlay);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã, –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π –∏ –∑–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    async function init() {
      await setupCamera();
      video.play();
      const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
      posenetModel = await posenet.load();
      onPlay();
    }
    init();
  </script>
</body>
</html>
